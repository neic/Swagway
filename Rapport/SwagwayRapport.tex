\documentclass[a4paper,oneside,article,danish,table,draft]{memoir}
\XeTeXtracingfonts= 1
\usepackage{babel,microtype,verbatim,amsmath,amssymb,unicode-math,ulem,url,siunitx,mhchem,tikz,pgfplots}
\sisetup{per-mode=symbol}
\microtypesetup{final,verbose=silent}
\usetikzlibrary{mindmap,arrows,positioning,shapes}
\setmainfont[Ligatures={TeX}]{Arno Pro}
\setmathfont{Arno Pro}
\setmathfont{[Asana-Math]}
%\hfuzz=1pt
\usepackage[margin,draft]{fixme}
\fxusetheme{color}

\newcommand{\authorvar}{Carl~Emil~Grøn~Christensen and Mathias~Dannesbo}
\newcommand{\pretitlevar}{0}
\newcommand{\titlevar}{Swagway} 
\newcommand{\subtitlevar}{0} 
\newcommand{\datevar}{\today} 
\newcommand{\subjectvar}{Teknikfag~A:~El}
\newcommand{\classvar}{}  
\newcommand{\teachervar}{}

\makepagestyle{articlehead}
\makeevenhead{articlehead}{}{\titlevar}{}
\makeevenfoot{articlehead}{}{}{\thepage}
\makeoddhead{articlehead}{}{\titlevar}{}
\makeoddfoot{articlehead}{}{}{\thepage}

\newcommand{\boarddate}[1]{\textcolor{blue!80!black}{#1}}


\begin{document}
% \includepdf{forside.pdf} \clearpage%------------------------ Forside

\begin{center}
  \if\pretitlevar 0
  \else{\Large\pretitlevar\\} \fi
  \textsc{\HUGE\titlevar\\}
  \if\subtitlevar 0
  \else {\Large\subtitlevar\\} \fi
  %\vspace{1em}
  {\LARGE 
  af\\
   \authorvar}\\
 \datevar\\
\end{center}

\vfill
\begin{abstract} %------------------------------ Abstract
  \fxwarning{Skriv resume}
\end{abstract}\vfill
\noindent
\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} ll}

\end{tabular*}

\thispagestyle{empty}
\clearpage
\setcounter{tocdepth}{2} \tableofcontents \clearpage


\chapter{Indledning}\label{chap:ind}
\section{Problemformulering}

\section{Indput}

\begin{table}[htbp]
  \caption[]{Pin forbindelser på Arduino}
  \centering
  \begin{tabular}{rll}
      \toprule
      Pin & Forbindelse & Egenskaber\\
      \midrule
      0 & USB Rx & \\
      1 & USB Tx & \\
      2 & Radio Rx & Interrupt\\
      3 & & Interrupt, PWM\\
      4 & Radio Tx & \\
      5 & Motorcontroller L3 & PWM\\
      6 & Motorcontroller L2 & PWM\\
      7 & Motorcontroller L1 & \\
      8 & Motorcontroller R1 & \\
      9 & Motorcontroller R2 & PWM\\
      10 & Motorcontroller R3 & PWM\\
      11 & & PWM\\
      12 & & \\
      13 & & LED\\
      A0 & & \\
      A1 & & \\
      A2 & Steering & \\
      A3 & Steering & \\
      A4 & IMU I²C SDA & SDA\\
      A5 & IMU I²C SCL & SCL
    \end{tabular}
    % \label{tab:}
  \end{table}

\subsection{Sensor}
I2C, Pull-up, Bus capasistance, level shifter,

\section{Control}

\subsection{Sensor læsning}

\subsection{Filter}
\subsubsection{Komplimentær filter}
\subsubsection{Kalman filter}
\subsubsection{Modificeret kalman filter}

\section{Output}

\subsection{Motorstyring}
\begin{table}[htbp]
  % \caption[]{}
  \centering
  \begin{tabular}{ccc|cccc|ccccl}
      \toprule
     P7&P6&P5 &Q1&Q2&Q3&Q4 &Q1&Q2&Q3&Q4\\
     P8&P9&P10 &Q5&Q6&Q7&Q8 &Q5&Q6&Q7&Q8\\
     \midrule
     0&0&0 &0&1&0&0 &0&0&0&1 & Off ($\circlearrowright$)\\
     1&0&0 &0&0&0&1 &0&1&0&0 & Off ($\circlearrowleft$)\\
     0&1&0 &1&1&0&0 &1&0&0&1 & $\circlearrowright$\\
     1&1&0 &1&0&0&1 &1&1&0&0 & Short\\
     0&0&1 &0&1&1&0 &0&0&1&1 & Short\\
     1&0&1 &0&0&1&1 &0&1&1&0 & $\circlearrowleft$\\
     0&1&1 &1&1&1&0 &1&0&1&1 & Short\\
     1&1&1 &1&0&1&1 &1&1&1&0 & Short\\
    \end{tabular}
    % \label{tab:}
  \end{table}

H-bro, PWM, PWM-kondensator, beskyttelses dioder, 4000 serie, optocopler

\subsection{Samlet board}
Det var uparktisk at have alle funktioner på samme board så H-broerne og optocouplerne blev flyttet på sit eget board “Motorcontroller v1.0”.

\subsubsection{Motorcontroller v1.0}
\boarddate{24. januar 2012}
\fxwarning{Indset diagram over Motorcontroller v1.0}
\fxwarning{Indset figur over Motorcontroller v1.0}
Boardet virkede ikke. Det opførte sig som det var kortsluttet. Det viste sig, efter at boardet var skilt helt af igen, at det plus tegn der skulle vise polariteten var sat ved den forkerte pol. Printet havde taget skade af at blive loddet på flere gange.

Der var desuden nolge ledninger der var for tætsiddene og loddeøerne var lidt underdimmentionerede. Der manglede også en mulighed for at se hvilken vej strømmen løber i H-borerne. Dette blev rettet i v2.0.
\subsubsection{Motorcontroller v2.0}
\boarddate{8. marts 2012} Dette board blev aldrig lavet færdig; Ledningerne omkring pinheaderen var for tæt efter at loddeøeren blev forstørret. Diagram og figur over printet kan findes i bilag. \fxwarning{ref}

\subsubsection{Motorcontroller v2.1}
\boarddate{8 marts 2012}

\fxwarning{Indset diagram over Motorcontroller v2.1 (Figur over printet kan findes i bilag)}

Boardet fungerede umiddelbart. Motoren kunne køre i begge retninger og farten kunne styres med PWM. Dog startede motoren på ca. 30\% fart i den ene retning. Ved at måle på PWM signalet fra mainboardet og signalet til motoeren kunne problemet indskrenkes til at være på Motorcontrolleren.

Det viste sig efter meget debugging at spændingen på gaten på P-kanal HEXFETerne (IRF4905) ikke gik high ligeså hurtigt som forventet. Der blev opstillet et forsøg på et breadboard med en P-kanal HEXFET, en optocoupler og en Arduino.

\fxwarning{Indset diagram over forsøg med optocoupler og HEXFET}

Forsøget viste at når optocoupleren sad mellem HEXFETen og Arduinoen var der en kapacitet mellem HEXFETens gate og source. Se figur \fxwarning{ref}.
\fxwarning{Indset billede af skob}

Ved at sætte en mindre pull-up-modstand på kunne den aflades hurtigere, men det var ikke muligt at få den tilpas langt ned til at kunne styre motoren godt. Ved at fjerne optocoupler og køre HEXFETens gate direkte fra Arduinoen eller ved fjerne HEXFETen og måle direkte på optocoupleren, var stigningstiden $\approx0$. Det var kun i kombination mellem HEXFETen og transistoen i optocoupleren at stigningstiden ikke var $\approx0$.

Der blev forsøgt med en 4N25 optocoupler istedet for 4N35 og en BC547 istedet for optocoupleren; der var samme stigningstid.

Det har ikke været muligt, selv med hjælp fra vejleder, at forklare hvorfor denne kapacitet er der.

Problemet blev ikke løst, det blev bare gjort ubetydeligt: Istedet for at bruge en N- og en P-kanal HEXFET til at bestemme retning og køre PWM på de andre to N- og P-kanal HEXFETer, blev det lavet om til at begge P-kanal HEXFETer blev brugt til at bestemme retning og at N-kanal HEXFETerne bliver brugt at køre PWM. Det er ikke et problem at stigetiden på P-kanal HEXFETerne er langsom da de kun ændre sig når der skiftes retning og ikke med høj frekvens som ved PWM.

For ikke at tilføje flere optocouplere og bruge flere pins på arduinoen blev der, på Motorcontrolleren tilføjet to invertere. Se figur \fxwarning{ref: dia:v3.0}
\subsubsection{Motorcontroller v3.0}
\boarddate{27. marts 2012}
\fxwarning{Indset diagram over Motorcontroller v3.0 (Figur over printet kan findes i bilag)}
Efter at der blev tilføjet en inventere på to af gatesne til P-kanal HEXFETerne er denne low når der ikke er spænding på optocouplerne (fx når den ikke er koblet til Mainboardet). Det tænder HEXFETen, det, sammen med N-kanal HEXFETerne som også er tændt uden spænding på optocouplerne, kortslutter H-broen. Motorcontroller v3.0 var fungerede, men det var upraktisk at den var kortsluttet unden at være koblet sammen med Mainboardet.

Pull-up modstandende blev erstattet af pull-down.
\subsubsection{Motorcontroller v4.0}
\boarddate{12. april 2012} Dette board blev aldrig lavet færdig. En stor del af boardet blev re-routed da der var blevet rodet efter mange versioner. Diagram og Figur over printet kan findes i bilag. \fxwarning{ref}
\subsubsection{Motorcontroller v4.1}
\boarddate{13. april 2012}
Der var en ledning der ikke var routed og der var nogle mindre re-routing.

\subsubsection{Motorcontroller v4.2}
\boarddate{17. april 2012}
Dette board fungere og sidder i Swagwayen.


\chapter{Konklusion} \label{chap:kon}
\clearpage
\listoftables
\listoffigures
% \nocite{*}
\bibliographystyle{dk-apali} \bibliography{bib}
\clearpage \appendix

\chapter{Status log}

\section{13. marts}
Mainbord er fungerende. v2.0 af motorboardet er næsten færdig.

Kredsløbet uden om printne er næsten færdig.

Vi kan læse data fra IMUen og vi har et halvt implementert kalman-filter.

Efter kalmanfilteret fungere skal der implementeres PID med wrapper kode.

\end{document}